{% extends 'base.html' %}

{% block content %}

<div class="container my-4">

    <h3 class="text-center mb-4">Preview Data</h3>

    <form method="post" action="{% url 'remove_duplicates' %}">
        {% csrf_token %}

        <!-- Table preview -->
        <div class="card card-preview p-3 mb-4">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            {% for col in columns %}
                            {% with "" as dup_class %}
                            {% for group, dup_cols in duplicates.items %}
                            {% if col in dup_cols %}
                            {% with "dup dup-group-"|add:forloop.counter as dup_class %}{% endwith %}
                            {% endif %}
                            {% endfor %}
                            <th class="{{ dup_class }}">{{ col }}</th>
                            {% endwith %}
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in preview_rows %}
                        <tr>
                            {% for cell in row %}
                            {% with columns|slice:forloop.counter0|first as col_name %}
                            {% with "" as dup_class %}
                            {% for group, dup_cols in duplicates.items %}
                            {% if col_name in dup_cols %}
                            {% with "dup dup-group-"|add:forloop.counter as dup_class %}{% endwith %}
                            {% endif %}
                            {% endfor %}
                            {% endwith %}
                            <td class="{{ dup_class }}">{{ cell }}</td>
                            {% endwith %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Duplicate handling messages & proceed button at bottom -->
        <div class="card card-preview p-3 text-center">
            {% if duplicates %}
            <div class="alert alert-warning mb-3">
                <strong>Duplicate columns detected!</strong><br>
                You can select which columns to remove or ignore duplicates below.
            </div>

            {% for group, dup_cols in duplicates.items %}
            <div class="mb-3 p-2 border rounded dup-group-{{ forloop.counter }}">
                <strong>Group {{ forloop.counter }}</strong>
                {% for col in dup_cols %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="remove_columns" value="{{ col }}"
                        id="col_{{ col }}">
                    <label class="form-check-label" for="col_{{ col }}">{{ col }}</label>
                </div>
                {% endfor %}
            </div>
            {% endfor %}

            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" name="ignore_duplicates" id="ignoreDuplicates">
                <label class="form-check-label" for="ignoreDuplicates">
                    Ignore duplicates and proceed
                </label>
            </div>

            <button type="submit" class="btn btn-primary btn-lg mt-4 px-5">Proceed</button>

            {% else %}
            <div class="alert alert-success mb-3">
                <strong>No duplicate columns found!</strong>
            </div>
            <button type="submit" class="btn btn-success btn-lg mt-2 px-5">Proceed</button>
            {% endif %}
        </div>

    </form>

</div>

{% endblock content %}
